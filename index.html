// =======================
// 初期データ読み込み
// =======================
let records = JSON.parse(localStorage.getItem("records")) || [];

// 表示中の年月
let displayDate = new Date();

// =======================
// ページ読み込み時
// =======================
window.onload = function () {
  updateDisplay();
};

// =======================
// 月表示更新
// =======================
function updateDisplay() {
  const displayMonth = displayDate.getMonth() + 1;
  const displayYear = displayDate.getFullYear();

  // 年月ラベル
  document.getElementById("monthLabel").textContent =
    displayYear + "年" + displayMonth + "月";

  const list = document.getElementById("list");
  list.innerHTML = "";

  let myCard = 0;
  let familyCard = 0;
  let cash = 0;

  records.forEach((r, index) => {
    const recordDate = new Date(r.date);
    const recordMonth = recordDate.getMonth() + 1;
    const recordYear = recordDate.getFullYear();

    // 表示月だけ
    if (recordMonth === displayMonth && recordYear === displayYear) {
      const li = document.createElement("li");

      li.innerHTML = `
        ${r.date} | ${r.account} | ${r.shop} | ${r.amount}円 | ${r.memo}
        <button onclick="deleteRecord(${index})">削除</button>
      `;

      list.appendChild(li);

      // 合計
      if (r.account === "自分カード") myCard += r.amount;
      if (r.account === "家族カード") familyCard += r.amount;
      if (r.account === "現金") cash += r.amount;
    }
  });

  if (list.innerHTML === "") {
    list.innerHTML = "<li>この月の記録はありません</li>";
  }

  document.getElementById("myCardTotal").textContent = myCard;
  document.getElementById("familyCardTotal").textContent = familyCard;
  document.getElementById("cashTotal").textContent = cash;
}

// =======================
// 月切替
// =======================
function prevMonth() {
  displayDate.setMonth(displayDate.getMonth() - 1);
  updateDisplay();
}

function nextMonth() {
  displayDate.setMonth(displayDate.getMonth() + 1);
  updateDisplay();
}

// =======================
// 削除
// =======================
function deleteRecord(index) {
  records.splice(index, 1);
  localStorage.setItem("records", JSON.stringify(records));
  updateDisplay();
}

// =======================
// CSV取り込み（重複防止付き）
// =======================
function importCSV() {
  const fileInput = document.getElementById("csvFile");
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function (e) {
    const text = e.target.result;
    const lines = text.split("\n");

    // 1行目でカード判定
    const header = lines[0];
    let accountType = "自分カード";

    if (header.includes("Ｏｌｉｖｅ")) {
      accountType = "自分カード";
    }
    if (header.includes("ゴールドＶＩＳＡ")) {
      accountType = "家族カード";
    }

    let addedCount = 0;

    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;

      const cols = line.split(",");

      const date = cols[0];
      const shop = cols[1];
      const amount = Number(cols[2]);

      if (!date || !amount) continue;

      const formattedDate = date.replace(/\//g, "-");

      // 重複チェック
      const isDuplicate = records.some(r =>
        r.date === formattedDate &&
        r.amount === amount &&
        r.shop === shop &&
        r.account === accountType
      );

      if (!isDuplicate) {
        records.push({
          date: formattedDate,
          amount: amount,
          account: accountType,
          shop: shop,
          memo: "CSV"
        });
        addedCount++;
      }
    }

    localStorage.setItem("records", JSON.stringify(records));
    updateDisplay();

    alert(addedCount + "件取り込みました");
  };

  reader.readAsText(file, "Shift_JIS");
}