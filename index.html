<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>支出メモ</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f2f4f7;
  margin: 0;
  padding: 0;
}

.container {
  max-width: 420px;
  margin: 0 auto;
  background: white;
  min-height: 100vh;
  padding: 16px;
  box-sizing: border-box;
}

h2 {
  margin-top: 0;
}

input, select, button {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  margin-bottom: 10px;
  font-size: 14px;
  box-sizing: border-box;
}

button {
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 6px;
}

button:hover {
  opacity: 0.9;
}

#summaryBox {
  background: #f5f5f5;
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 12px;
  line-height: 1.6;
}

#bigTotal {
  text-align: center;
  font-size: 14px;
  color: #666;
}

#bigTotal span {
  font-size: 28px;
  font-weight: bold;
  color: #000;
}

#reportPage {
  padding: 12px;
}

#chartTooltip {
  position: absolute;
  background: rgba(0,0,0,0.8);
  color: #fff;
  padding: 6px 10px;
  font-size: 12px;
  border-radius: 6px;
  pointer-events: none;
  white-space: nowrap;
  transform: translate(-50%, -120%);
  z-index: 10;
}

.dashboard {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.card {
  flex: 1;
  background: #fff;
  border-radius: 10px;
  padding: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.card-title {
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
}

.card-value {
  font-size: 20px;
  font-weight: bold;
}

.report-card {
  background: #fff;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  margin-bottom: 12px;
}

.filter-panel {
  border: 1px solid #ccc;
  padding: 10px;
  margin: 8px 0;
  background: #f9f9f9;
  font-size: 14px;
}

/* 月ナビ */
.month-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.month-nav button {
  width: 60px;
}

/* リスト */
#list {
  padding: 0;
  margin: 0;
}

li {
  list-style: none;
  padding: 6px 8px;
  border-bottom: 1px solid #eee;
  width: 100%;
  box-sizing: border-box;
}

/* 上段 */
.item-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  width: 100%;
}

.date {
  width: 90px;
  flex-shrink: 0;
  color: #666;
}

.shop {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.amount {
  width: 90px;
  text-align: right;
  font-weight: bold;
  flex-shrink: 0;
}

/* 下段 */
.item-sub {
  font-size: 12px;
  color: #888;
  margin-left: 98px;
}

/* 削除ボタン */
.delete-btn {
  background: none;
  border: none;
  color: #bbb;
  font-size: 14px;
  cursor: pointer;
  flex-shrink: 0;
  width: auto;
  padding: 0;
  margin: 0;
}

.delete-btn:hover {
  color: #888;
}

.legend {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 12px;
  font-size: 12px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.legend-color {
  width: 10px;
  height: 10px;
  border-radius: 2px;
}

.chart-scroll {
  overflow-x: auto;
}

.chart-scroll canvas {
  min-width: 600px;
}

#monthlyChartContainer {
  display: flex;
  width: 100%;
  height: 260px;
}

#monthlyChartScroll {
  overflow-x: auto;
  width: 100%;
}

#monthlyChart {
  display: block;
  height: 260px;
}

#monthlyYAxis {
  width: 60px;
  height: 260px;
  flex-shrink: 0;
  background: #fff;
  border-right: 1px solid #ddd;
}

#bankChartContainer {
  display: flex;
  width: 100%;
  height: 180px;
}

#bankChartScroll {
  overflow-x: auto;
  width: 100%;
}

#bankChartAxis {
  width: 60px;
  flex-shrink: 0;
  background: #fff;
  border-right: 1px solid #ddd;
}

#chartLegend {
  font-size: 11px;
  margin-top: 6px;
  line-height: 1.6;
}

/* =========================
   全体デザイン統一（A）
========================= */

/* 見出しの余白統一 */
h2 {
  font-size: 18px;
  margin-bottom: 8px;
}

h3 {
  font-size: 14px;
  margin: 16px 0 6px;
  color: #444;
}

/* ボタン統一 */
button {
  background: #4CAF50;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 14px;
}

button:active {
  transform: scale(0.98);
}

/* 入力系を少しカード風に */
input, select {
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fff;
}

/* タブっぽくする */
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.tabs button {
  flex: 1;
  background: #e9edf2;
  color: #333;
  font-weight: 500;
}

.tabs button:hover {
  background: #dde3ea;
}

/* サマリーの影を統一 */
#summaryBox {
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

/* レポートカードと統一 */
.report-card {
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

/* グラフ凡例の余白 */
#chartLegend {
  margin-top: 8px;
}

/* 月ナビを少し強調 */
.month-nav span {
  font-weight: bold;
  font-size: 16px;
}
</style>

</head>

<body>
<div class="container">

<div class="tabs">
  <button onclick="showPage('main')">記録</button>
  <button onclick="showPage('report')">月次レポート</button>
</div>

<div id="mainPage">

<h2>支出記録</h2>

<div class="month-nav">
  <button onclick="prevMonth()">＜</button>
  <span id="monthLabel"></span>
  <button onclick="nextMonth()">＞</button>
</div>

<h3>カテゴリフィルター</h3>
<button onclick="toggleFilter()">フィルター</button>

<div id="filterPanel" class="filter-panel" style="display:none;">
  <button onclick="selectAllCategories()">全選択</button>
  <button onclick="clearAllCategories()">全解除</button>
  <br><br>

  <label><input type="checkbox" value="食費" checked onchange="updateDisplay()"> 食費</label><br>
  <label><input type="checkbox" value="外食" checked onchange="updateDisplay()"> 外食</label><br>
  <label><input type="checkbox" value="日用品" checked onchange="updateDisplay()"> 日用品</label><br>
  <label><input type="checkbox" value="交通" checked onchange="updateDisplay()"> 交通</label><br>
  <label><input type="checkbox" value="固定費" checked onchange="updateDisplay()"> 固定費</label><br>
  <label><input type="checkbox" value="レジャー" checked onchange="updateDisplay()"> レジャー</label><br>
  <label><input type="checkbox" value="その他" checked onchange="updateDisplay()"> その他</label>
</div>

<h3>今月サマリー</h3>

<div id="dashboard" class="dashboard">
  <div class="card">
    <div class="card-title">銀行残高</div>
    <div class="card-value" id="bankBalance">0円</div>
  </div>

  <div class="card">
    <div class="card-title">今月支出</div>
    <div class="card-value" id="monthTotal">0円</div>
  </div>
</div>

<div id="summaryBox">

  <div id="bigTotal">
    今月合計<br>
    <span id="totalAmount">0</span> 円
  </div>

  <hr>

  自分カード：<span id="myCardTotal">0</span>円<br>
  家族カード：<span id="familyCardTotal">0</span>円<br>
  現金：<span id="cashTotal">0</span>円<br><br>

  <div id="categoryTotals"></div>

</div>

<button onclick="addRecord()" style="margin-bottom:16px;">追加</button>

<div id="recordForm" style="display:none;">

日付: <input type="date" id="date"><br><br>
金額: <input type="number" id="amount"><br><br>

支払い方法:
<select id="account">
  <option value="自分カード">自分カード</option>
  <option value="家族カード">家族カード</option>
  <option value="現金">現金</option>
</select>
<br><br>

店名: <input type="text" id="shop"><br><br>

カテゴリ:
<select id="category">
  <option value="食費">食費</option>
  <option value="外食">外食</option>
  <option value="日用品">日用品</option>
  <option value="交通">交通</option>
  <option value="固定費">固定費</option>
  <option value="レジャー">レジャー</option>
  <option value="その他">その他</option>
</select>
<br><br>

メモ: <input type="text" id="memo"><br><br>
</div>

<button onclick="addRecord()">追加</button>

<h3>CSV取り込み（三井住友）</h3>
<input type="file" id="csvFile" accept=".csv">
<button onclick="importCSV()">取り込み</button>
<br><br>

<h3>銀行CSV取り込み</h3>
<input type="file" id="bankCsvFile" accept=".csv">
<button onclick="importBankCSV()">銀行取り込み</button>

<h3>記録一覧</h3>
<ul id="list"></ul>

</div>

<div id="reportPage" style="display:none;">

  <div class="report-card">
    <h2>月次レポート</h2>

    <h3>銀行残高推移</h3>
    <div style="display:flex;">
      <canvas id="bankChartAxis" width="60" height="180"></canvas>

      <div style="overflow-x:auto;">
        <canvas id="bankChart" height="180" style="min-width:600px;"></canvas>
      </div>
    </div>

    <!-- 月次カテゴリグラフ -->
    <div id="monthlyChartContainer">
      <canvas id="monthlyYAxis" height="260"></canvas>

      <div id="monthlyChartScroll">
        <canvas id="monthlyChart" height="260"></canvas>
      </div>
    </div>

    <div id="chartLegend"></div>

    <!-- 月別テキストレポート -->
    <div id="monthlyReport">
      <h3>月別一覧</h3>
      <div id="monthlyList"></div>

      <h3>前月比較</h3>
      <div id="monthCompare"></div>
    </div>

  </div>

</div>


<div id="chartTooltip" style="
  position: fixed;
  background: rgba(0,0,0,0.75);
  color: white;
  padding: 6px 8px;
  border-radius: 6px;
  font-size: 12px;
  pointer-events: none;
  display: none;
  z-index: 9999;
"></div>



<script>

// =======================
// 初期データ読み込み
// =======================
let records = JSON.parse(localStorage.getItem("records")) || [];

// ===== 銀行データ（追加）=====
let bankRecords = JSON.parse(localStorage.getItem("bankRecords")) || [];

const categoryRules = [

  // ===== 食費（スーパー・コンビニ）=====
  { keyword: "セブン", category: "食費" },
  { keyword: "ファミマ", category: "食費" },
  { keyword: "ファミリーマート", category: "食費" },
  { keyword: "ローソン", category: "食費" },
  { keyword: "マルエツ", category: "食費" },
  { keyword: "ライフ", category: "食費" },
  { keyword: "サミット", category: "食費" },
  { keyword: "ハナマサ", category: "食費" },
  { keyword: "まいばすけっと", category: "食費" },
  { keyword: "リコス", category: "食費" },

  // ===== 外食 =====
  { keyword: "焼肉", category: "外食" },
  { keyword: "天ぷら", category: "外食" },
  { keyword: "松屋", category: "外食" },
  { keyword: "大戸屋", category: "外食" },
  { keyword: "マクドナルド", category: "外食" },
  { keyword: "UBERJP_EATS", category: "外食" },
  { keyword: "スシロー", category: "外食" },
  { keyword: "やよい軒", category: "外食" },
  { keyword: "餃子の王将", category: "外食" },
  { keyword: "キリンシティ", category: "外食" },
  { keyword: "日高屋", category: "外食" },
  { keyword: "すき家", category: "外食" },
  { keyword: "吉野家", category: "外食" },
  { keyword: "鳥貴族", category: "外食" },
  { keyword: "ボン花火", category: "外食" },
  { keyword: "イエロ", category: "外食" },
  { keyword: "ドトール", category: "外食" },
  { keyword: "プロント", category: "外食" },
  { keyword: "そば", category: "外食" },
  { keyword: "カフェ", category: "外食" },
  { keyword: "cafe", category: "外食" },
  { keyword: "CAFE", category: "外食" },
  { keyword: "ｃａｆｅ", category: "外食" },
  { keyword: "ＣＡＦＥ", category: "外食" },
  { keyword: "コーヒー", category: "外食" },
  { keyword: "coffee", category: "外食" },
  { keyword: "COFFEE", category: "外食" },
  { keyword: "ｃｏｆｆｅｅ", category: "外食" },
  { keyword: "ＣＯＦＦＥＥ", category: "外食" },
  { keyword: "レストラン", category: "外食" },
  { keyword: "ブルーシール", category: "外食" },
  { keyword: "Ａ＆Ｗ", category: "外食" },

  { keyword: "ラクテンペイ", category: "外食" },
  { keyword: "楽天ペイ", category: "外食" },

  // ===== 日用品 =====
  { keyword: "AMAZON.CO.JP", category: "日用品" },
  { keyword: "ＡＭＡＺＯＮ．ＣＯ", category: "日用品" },
  { keyword: "AMAZON", category: "日用品" },
  { keyword: "ＡＭＡＺＯＮ", category: "日用品" },
  { keyword: "楽天", category: "日用品" },
  { keyword: "無印", category: "日用品" },
  { keyword: "ニトリ", category: "日用品" },
  { keyword: "ダイソー", category: "日用品" },
  { keyword: "ワッツ", category: "日用品" },
  { keyword: "セリア", category: "日用品" },
  { keyword: "ハンズ", category: "日用品" },
  { keyword: "ドン・キホーテ", category: "日用品" },
  { keyword: "マツモトキヨシ", category: "日用品" },
  { keyword: "ドラッグ", category: "日用品" },

  // ===== 交通 =====
  { keyword: "バス", category: "交通" },
  { keyword: "交通", category: "交通" },
  { keyword: "京成", category: "交通" },
  { keyword: "スカイライナー", category: "交通" },
  { keyword: "ＧＯアプリ", category: "交通" },
  { keyword: "タクシー", category: "交通" },
  { keyword: "キャブ", category: "交通" },
  { keyword: "カーシェア", category: "交通" },
  { keyword: "第一交通", category: "交通" },
  { keyword: "国際自動車", category: "交通" },
  { keyword: "PASMO", category: "交通" },
  { keyword: "ＰＡＳＭＯ", category: "交通" },
  { keyword: "ETC", category: "交通" },
  { keyword: "ＥＴＣ", category: "交通" },
  { keyword: "給油", category: "交通" },

  // ===== 固定費 =====
  { keyword: "東京電力", category: "固定費" },
  { keyword: "電力", category: "固定費" },
  { keyword: "水道", category: "固定費" },

  // ===== レジャー・旅行 =====
  { keyword: "ホテル", category: "レジャー" },
  { keyword: "レンタカー", category: "レジャー" },
  { keyword: "skyticket", category: "レジャー" },
  { keyword: "ｓｋｙｔｉｃｋｅｔ", category: "レジャー" },
  { keyword: "水族館", category: "レジャー" },
  { keyword: "じゃらん", category: "レジャー" },
  { keyword: "御菓子御殿", category: "レジャー" },

  // ===== 決済系（中身不明）=====
  { keyword: "Square", category: "その他" },
  { keyword: "Ｓｑｕａｒｅ", category: "その他" },
  { keyword: "楽天ペイ", category: "その他" }
];

const categoryColors = {
  "食費": "#4CAF50",
  "外食": "#FF9800",
  "日用品": "#2196F3",
  "交通": "#9C27B0",
  "固定費": "#607D8B",
  "レジャー": "#E91E63",
  "その他": "#9E9E9E"
};

// 表示中の年月
let displayDate = new Date();

let filterCategory = "all";

const categories = [
  "食費",
  "外食",
  "日用品",
  "交通",
  "固定費",
  "レジャー",
  "その他"
];

// =======================
// ページ読み込み時
// =======================
window.onload = function () {
  updateDisplay();
};

function showPage(page) {
  document.getElementById("mainPage").style.display = "none";
  document.getElementById("reportPage").style.display = "none";

  if (page === "main") {
    document.getElementById("mainPage").style.display = "block";
  } else {
    document.getElementById("reportPage").style.display = "block";
    updateMonthlyReport();
  }
  if (page === "report") {
    drawMonthlyChartByCategory();
    drawBankBalanceChart();   // ←銀行グラフ
  }
}


function updateMonthlyReport() {
  const reportDiv = document.getElementById("monthlyReport");
  if (!reportDiv) return; // 要素なければ何もしない

  let monthMap = {};

  records.forEach(r => {
    const d = new Date(r.date);
    const key = d.getFullYear() + "-" + (d.getMonth() + 1);
    monthMap[key] = (monthMap[key] || 0) + Number(r.amount);
  });

  drawMonthlyChartByCategory();

  const sortedMonths = Object.keys(monthMap).sort((a,b)=>{
    return new Date(a) - new Date(b);
  });

  // 一覧表示
  const listDiv = document.getElementById("monthlyList");
  listDiv.innerHTML = "";

  sortedMonths.slice().reverse().forEach(m => {
    listDiv.innerHTML += `${m}：${monthMap[m].toLocaleString()}円<br>`;
  });

  // 前月比較
  const compareDiv = document.getElementById("monthCompare");

  if (sortedMonths.length >= 2) {
    const last = sortedMonths[sortedMonths.length - 1];
    const prev = sortedMonths[sortedMonths.length - 2];

    const diff = monthMap[last] - monthMap[prev];
    const sign = diff >= 0 ? "+" : "";

    compareDiv.innerHTML = `
      今月：${monthMap[last].toLocaleString()}円<br>
      前月：${monthMap[prev].toLocaleString()}円<br>
      差：${sign}${diff.toLocaleString()}円
    `;
  } else {
    compareDiv.innerHTML = "データがまだ少ないです";
  }

  drawLegend();
}

function detectCategory(shopName) {
  if (!shopName) return "その他";

  const s = shopName.toUpperCase();

  for (let rule of categoryRules) {
    if (s.includes(rule.keyword.toUpperCase())) {
      return rule.category;
    }
  }
  return "その他";
}

// フィルター開閉
function toggleFilter() {
  const panel = document.getElementById("filterPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}

// 全選択
function selectAllCategories() {
  const checks = document.querySelectorAll("#filterPanel input[type='checkbox']");
  checks.forEach(c => c.checked = true);
  updateDisplay();
}

// 全解除
function clearAllCategories() {
  const checks = document.querySelectorAll("#filterPanel input[type='checkbox']");
  checks.forEach(c => c.checked = false);
  updateDisplay();
}

// 選択カテゴリ取得（updateDisplayで使う）
function getSelectedCategories() {
  const checks = document.querySelectorAll("#filterPanel input[type='checkbox']:checked");
  return Array.from(checks).map(c => c.value);
}

// =======================
// 月表示更新
// =======================
function updateDisplay() {
  const displayMonth = displayDate.getMonth() + 1;
  const displayYear = displayDate.getFullYear();

  // 年月ラベル
  document.getElementById("monthLabel").textContent =
    displayYear + "年" + displayMonth + "月";

  const list = document.getElementById("list");
  list.innerHTML = "";

  // ===== 選択カテゴリ =====
  const checkedBoxes = document.querySelectorAll("#filterPanel input:checked");
  const selectedCategories = Array.from(checkedBoxes).map(cb => cb.value);

  let myCard = 0;
  let familyCard = 0;
  let cash = 0;

  let categoryMap = {};

  // ===== 月フィルター =====
  const filteredRecords = records.filter(r => {
    const d = new Date(r.date);
    return (
      d.getMonth() + 1 === displayMonth &&
      d.getFullYear() === displayYear
    );
  });

  // ===== 表示 =====
  filteredRecords.forEach((r, originalIndex) => {
    const category = r.category || "その他";

    // カテゴリフィルター
    if (!selectedCategories.includes(category)) return;

    const li = document.createElement("li");

    li.innerHTML = `
      <div class="item-row">
        <span class="date">${r.date}</span>
        <span class="shop">${r.shop}</span>
        <span class="amount">${Number(r.amount).toLocaleString()}円</span>
        <button class="delete-btn" onclick="deleteRecord(${originalIndex})">×</button>
      </div>

      <div class="item-sub">
        <select onchange="changeCategory(${originalIndex}, this.value)">
          <option value="食費" ${category === "食費" ? "selected" : ""}>食費</option>
          <option value="外食" ${category === "外食" ? "selected" : ""}>外食</option>
          <option value="日用品" ${category === "日用品" ? "selected" : ""}>日用品</option>
          <option value="交通" ${category === "交通" ? "selected" : ""}>交通</option>
          <option value="固定費" ${category === "固定費" ? "selected" : ""}>固定費</option>
          <option value="レジャー" ${category === "レジャー" ? "selected" : ""}>レジャー</option>
          <option value="その他" ${category === "その他" ? "selected" : ""}>その他</option>
        </select>
        ｜${r.account}
        ${r.memo ? `｜${r.memo}` : ""}
      </div>
    `;

    list.appendChild(li);

    // カード合計
    if (r.account === "自分カード") myCard += r.amount;
    if (r.account === "家族カード") familyCard += r.amount;
    if (r.account === "現金") cash += r.amount;

    // カテゴリ合計
    categoryMap[category] = (categoryMap[category] || 0) + Number(r.amount);
  });

  if (list.innerHTML === "") {
    list.innerHTML = "<li>該当する記録がありません</li>";
  }

  // ===== カテゴリ表示 =====
  const categoryDiv = document.getElementById("categoryTotals");
  categoryDiv.innerHTML = "";

  for (let cat in categoryMap) {
    categoryDiv.innerHTML +=
      `${cat}：${categoryMap[cat].toLocaleString()}円<br>`;
  }

  // ===== 総合計 =====
  document.getElementById("myCardTotal").textContent = myCard;
  document.getElementById("familyCardTotal").textContent = familyCard;
  document.getElementById("cashTotal").textContent = cash;

  const total = myCard + familyCard + cash;
  document.getElementById("totalAmount").textContent = total.toLocaleString();

  updateMonthlyReport();

  const balanceEl = document.getElementById("bankBalance");
  if (balanceEl) {
    balanceEl.textContent = getLatestBalance().toLocaleString();
  }

  updateBankUI();
  updateMonthTotalUI();
}

function updateBankDisplay() {
  drawBankBalanceChart();

  const balanceEl = document.getElementById("latestBankBalance");
  if (balanceEl) {
    balanceEl.textContent = (balance / 10000).toLocaleString() + "万円";
  }
}

function updateBankUI() {
  const el = document.getElementById("bankBalance");
  if (!el) return;

  const balance = getLatestBalance();
  el.textContent = balance.toLocaleString() + "円";
}

function updateMonthTotalUI() {
  const el = document.getElementById("monthTotal");
  if (!el) return;

  let total = 0;

  records.forEach(r => {
    const d = new Date(r.date);
    if (
      d.getFullYear() === displayDate.getFullYear() &&
      d.getMonth() === displayDate.getMonth()
    ) {
      total += Number(r.amount);
    }
  });

  el.textContent = total.toLocaleString() + "円";
}

function drawMonthlyChart(monthMap) {
  const canvas = document.getElementById("monthlyChart");
  const ctx = canvas.getContext("2d");

  const months = Object.keys(monthMap).sort((a,b)=> new Date(a) - new Date(b));
  const values = months.map(m => monthMap[m]);

  if (months.length === 0) return;

  canvas.width = canvas.parentElement.offsetWidth;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const max = Math.max(...values);
  const barWidth = canvas.width / months.length;

  months.forEach((month, i) => {
    const value = monthMap[month];
    const height = (value / max) * (canvas.height - 40);

    const x = i * barWidth + 10;
    const y = canvas.height - height - 20;

    // 棒
    ctx.fillStyle = "#4CAF50";
    ctx.fillRect(x, y, barWidth - 20, height);

    // 月ラベル
    ctx.fillStyle = "#333";
    ctx.font = "10px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText(month.split("-")[1] + "月", x + (barWidth - 20)/2, canvas.height - 5);
  });
}

function drawMonthlyChartByCategory() {

  const chartCanvas = document.getElementById("monthlyChart");
  const yCanvas = document.getElementById("monthlyYAxis");

  if (!chartCanvas || !yCanvas) return;

  const chartCtx = chartCanvas.getContext("2d");
  const yCtx = yCanvas.getContext("2d");

  const chartHeightPx = 260;

  // ★高さ統一（先に取得してから設定）
  chartCanvas.height = chartHeightPx;
  yCanvas.height = chartHeightPx;
  yCanvas.width = 60;

  const selectedCategories = getSelectedCategories();
  let hoverAreas = [];
  let monthMap = {};

  records.forEach(r => {
    const d = new Date(r.date);
    const key = d.getFullYear() + "-" + (d.getMonth() + 1);
    const category = r.category || "その他";

    if (!selectedCategories.includes(category)) return;

    if (!monthMap[key]) monthMap[key] = {};
    monthMap[key][category] =
      (monthMap[key][category] || 0) + Number(r.amount);
  });

  const months = Object.keys(monthMap).sort((a,b)=> new Date(a) - new Date(b));
  if (months.length === 0) return;

  const barWidth = 30;   // ← 少し細く
  const gap = 25;
  const sidePadding = 20;

  const bottomPadding = 30;
  const topPadding = 10;

  const chartHeight = chartCanvas.height - bottomPadding - topPadding;

  const totals = months.map(m =>
    Object.values(monthMap[m]).reduce((a,b)=>a+b,0)
  );

  const maxTotal = Math.max(...totals);
  const unit = 100000;
  const maxAxis = Math.ceil(maxTotal / unit) * unit || unit;

  // 横スクロール幅
  chartCanvas.width =
  months.length * (barWidth + gap) + sidePadding * 2;

  chartCtx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
  yCtx.clearRect(0, 0, yCanvas.width, yCanvas.height);

  // ===== Y軸 =====
  yCtx.fillStyle = "#666";
  yCtx.font = "11px sans-serif";
  yCtx.textAlign = "right";
  yCtx.textBaseline = "middle";

  for (let v = 0; v <= maxAxis; v += unit) {
    const y =
      chartCanvas.height -
      bottomPadding -
      (v / maxAxis) * chartHeight;

    yCtx.fillText((v/10000) + "万円", 55, y);

    chartCtx.beginPath();
    chartCtx.moveTo(0, y);
    chartCtx.lineTo(chartCanvas.width, y);
    chartCtx.strokeStyle = "#eee";
    chartCtx.stroke();
  }

  // ===== 棒描画 =====
  months.forEach((month, i) => {

    let stackedHeight = 0;
    const x = sidePadding + i * (barWidth + gap);

    categories.forEach(cat => {

      const value = (monthMap[month][cat] || 0);
      if (!value) return;

      const height = (value / maxAxis) * chartHeight;
      const y =
        chartCanvas.height -
        bottomPadding -
        stackedHeight -
        height;

      chartCtx.fillStyle = categoryColors[cat];
      chartCtx.fillRect(x, y, barWidth, height);

      hoverAreas.push({
        month,
        category: cat,
        value,
        x,
        y,
        width: barWidth,
        height
      });

      stackedHeight += height;
    });

    chartCtx.fillStyle = "#333";
    chartCtx.font = "10px sans-serif";
    chartCtx.textAlign = "center";
    chartCtx.fillText(
      month.split("-")[1] + "月",
      x + barWidth/2,
      chartCanvas.height - 5
    );
  });

  // ===== ホバー =====
  const tooltip = document.getElementById("chartTooltip");

  chartCanvas.onmousemove = function(e) {
    const rect = chartCanvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    let found = null;

    hoverAreas.forEach(area => {
      if (
        mouseX >= area.x &&
        mouseX <= area.x + area.width &&
        mouseY >= area.y &&
        mouseY <= area.y + area.height
      ) {
        found = area;
      }
    });

    if (found) {
      tooltip.style.display = "block";
      tooltip.style.left = e.pageX + "px";
      tooltip.style.top = e.pageY + "px";
      tooltip.innerHTML =
        `${found.month}<br>${found.category}：${found.value.toLocaleString()}円`;
    } else {
      tooltip.style.display = "none";
    }
  };

  chartCanvas.onmouseleave = function() {
    tooltip.style.display = "none";
  };

  drawLegend();

  // ===== 最新月へ自動スクロール =====
  const scrollArea = document.getElementById("monthlyChartScroll");
  if (scrollArea) {
    scrollArea.scrollLeft = scrollArea.scrollWidth;
  }
}


function drawLegend() {
  const legend = document.getElementById("chartLegend");
  legend.innerHTML = "";

  const selectedCategories = getSelectedCategories();

  selectedCategories.forEach(cat => {
    const color = categoryColors[cat];

    legend.innerHTML += `
      <span style="display:inline-block; margin-right:10px;">
        <span style="
          display:inline-block;
          width:10px;
          height:10px;
          background:${color};
          margin-right:4px;
        "></span>
        ${cat}
      </span>
    `;
  });
}


function getLatestBalance() {
  return Number(localStorage.getItem("latestBankBalance")) || 0;
}

function drawBankBalanceChart() {
  const canvas = document.getElementById("bankChart");
  const axisCanvas = document.getElementById("bankChartAxis");

  if (!canvas || !axisCanvas) return;
  if (!bankRecords || bankRecords.length === 0) return;

  const ctx = canvas.getContext("2d");
  const axisCtx = axisCanvas.getContext("2d");

  // =====================
  // 月末残高
  // =====================
  let monthEndMap = {};

  bankRecords.forEach(r => {
    const d = new Date(r.date);
    const key = d.getFullYear() + "-" + (d.getMonth() + 1);

    if (
      !monthEndMap[key] ||
      new Date(r.date) > new Date(monthEndMap[key].date)
    ) {
      monthEndMap[key] = r;
    }
  });

  const months = Object.keys(monthEndMap).sort(
    (a, b) => new Date(a) - new Date(b)
  );
  if (months.length === 0) return;

  // 横幅（スクロール用）
  canvas.width = Math.max(months.length * 80, 600);
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  axisCtx.clearRect(0, 0, axisCanvas.width, axisCanvas.height);

  const balances = months.map(m => monthEndMap[m].balance);

  const max = Math.max(...balances);
  const min = Math.min(...balances);

  // ★10万円単位に丸める
  const unit = 100000;
  const displayMax = Math.ceil(max / unit) * unit;
  const displayMin = Math.floor(min / unit) * unit;
  const range = displayMax - displayMin || unit;

  const padding = 20;
  const chartHeight = canvas.height - padding * 2;
  const stepX =
    months.length > 1
      ? (canvas.width - padding * 2) / (months.length - 1)
      : 0;

  // =====================
  // Y軸（固定canvasに描画）
  // =====================
  axisCtx.strokeStyle = "#eee";
  axisCtx.fillStyle = "#666";
  axisCtx.font = "10px sans-serif";
  axisCtx.textAlign = "right";

  const steps = range / unit;

  for (let i = 0; i <= steps; i++) {
    const value = displayMin + unit * i;

    const y =
      axisCanvas.height -
      padding -
      ((value - displayMin) / range) * chartHeight;

    // グリッド線（グラフ側）
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
    ctx.strokeStyle = "#f0f0f0";
    ctx.stroke();

    // ラベル（軸側）
    axisCtx.fillText(
      Math.round(value / 10000) + "万円",
      axisCanvas.width - 5,
      y + 3
    );
  }

  // =====================
  // 折れ線
  // =====================
  ctx.strokeStyle = "#4A90E2";
  ctx.lineWidth = 2;
  ctx.beginPath();

  let points = [];

  months.forEach((month, i) => {
    const balance = monthEndMap[month].balance;

    const x = padding + i * stepX;
    const y =
      canvas.height -
      padding -
      ((balance - displayMin) / range) * chartHeight;

    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);

    points.push({ x, y, month, balance });
  });

  ctx.stroke();

  // 点
  ctx.fillStyle = "#4A90E2";
  points.forEach(p => {
    ctx.beginPath();
    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
    ctx.fill();
  });

  // 月ラベル
  ctx.fillStyle = "#333";
  ctx.font = "10px sans-serif";
  ctx.textAlign = "center";

  months.forEach((month, i) => {
    const x = padding + i * stepX;
    const m = month.split("-")[1];
    ctx.fillText(m + "月", x, canvas.height - 5);
  });

  // =====================
  // ホバー
  // =====================
  const tooltip = document.getElementById("chartTooltip");
  if (!tooltip) return;

  canvas.onmousemove = function(e) {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    let found = null;

    points.forEach(p => {
      const dx = mouseX - p.x;
      const dy = mouseY - p.y;
      if (Math.sqrt(dx * dx + dy * dy) < 10) {
        found = p;
      }
    });

    if (found) {
      tooltip.style.display = "block";
      tooltip.style.left = e.clientX + 10 + "px";
      tooltip.style.top = e.clientY - 20 + "px";

      const [y, m] = found.month.split("-");
      tooltip.innerHTML =
        `${y}年${m}月<br><strong>${found.balance.toLocaleString()}円</strong>`;
    } else {
      tooltip.style.display = "none";
    }
  };

  canvas.onmouseleave = function() {
    tooltip.style.display = "none";
  };
}

function addRecord() {
  const date = document.getElementById("date").value;
  const amount = Number(document.getElementById("amount").value);
  const account = document.getElementById("account").value;
  const shop = document.getElementById("shop").value;
  const category = document.getElementById("category").value;
  const memo = document.getElementById("memo").value;

  if (!date || !amount) {
    alert("日付と金額は必須です");
    return;
  }

  records.push({
    date: date,
    amount: amount,
    account: account,
    shop: shop,
    category: category,
    memo: memo
  });

  localStorage.setItem("records", JSON.stringify(records));
  updateDisplay();

  // 入力リセット
  document.getElementById("amount").value = "";
  document.getElementById("shop").value = "";
  document.getElementById("memo").value = "";
}

// =======================
// 月切替
// =======================
function prevMonth() {
  displayDate.setMonth(displayDate.getMonth() - 1);
  updateDisplay();
}

function nextMonth() {
  displayDate.setMonth(displayDate.getMonth() + 1);
  updateDisplay();
}

// =======================
// 削除
// =======================
function deleteRecord(index) {
  records.splice(index, 1);
  localStorage.setItem("records", JSON.stringify(records));
  updateDisplay();
}

// =======================
// CSV取り込み（重複防止付き）
// =======================
function importCSV() {
  const fileInput = document.getElementById("csvFile");
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function (e) {
    const text = e.target.result;
    const lines = text.split("\n");

    // 1行目でカード判定
    const header = lines[0];
    let accountType = "自分カード";

    if (header.includes("Ｏｌｉｖｅ")) {
      accountType = "自分カード";
    }
    if (header.includes("ゴールドＶＩＳＡ")) {
      accountType = "家族カード";
    }

    let addedCount = 0;

    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;

      const cols = line.split(",");

      const date = cols[0];
      const shop = cols[1];
      const amount = Number(cols[2]);

      if (!date || !amount) continue;

      const formattedDate = date.replace(/\//g, "-");

      const category = detectCategory(shop);


      // 重複チェック
      const isDuplicate = records.some(r =>
        r.date === formattedDate &&
        r.amount === amount &&
        r.shop === shop &&
        r.account === accountType
      );

      if (!isDuplicate) {
        records.push({
	  date: formattedDate,
	  amount,
	  account: accountType,
	  shop,
	  category: category,
	  memo: "CSV"
	});
        addedCount++;
      }
    }

    localStorage.setItem("records", JSON.stringify(records));
    updateDisplay();

    alert(addedCount + "件取り込みました");
  };

  reader.readAsText(file, "Shift_JIS");
}

// 数値変換関数
function parseNumber(str) {
  if (!str) return 0;

  return Number(
    String(str)
      .replace(/,/g, "")
      .replace(/[^\d\-]/g, "") // 数字とマイナス以外全部削除
  ) || 0;
}

// =======================
// 銀行CSV取り込み
// =======================
function importBankCSV() {

  const fileInput = document.getElementById("bankCsvFile");
  const file = fileInput.files[0];
  if (!file) {
    alert("CSVファイルを選択してください");
    return;
  }

  const reader = new FileReader();

  reader.onload = function(e) {
    const text = e.target.result;
    const lines = text.split("\n");

    let added = 0;

    for (let i = 1; i < lines.length; i++) {

      let line = lines[i].trim();
      if (!line) continue;

      // ===== ダブルクォート除去 =====
      const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
      if (!cols) continue;

      if (i === 1) console.log(cols);

      // 先頭と末尾の " を除去
      for (let j = 0; j < cols.length; j++) {
        cols[j] = cols[j].replace(/^"|"$/g, "");
      }
      if (cols.length < 5) continue;

      const dateStr = cols[0];
      const description = cols[1];
      const outAmount = parseNumber(cols[2]);
      const inAmount = parseNumber(cols[3]);
      const balance = parseNumber(cols[4]);

      // 日付整形
      const formattedDate = dateStr.replace(/\//g, "-");

      const amount = inAmount > 0 ? inAmount : -outAmount;

      // 重複チェック（重要）
      const isDuplicate = bankRecords.some(r =>
        r.date === formattedDate &&
        r.amount === amount &&
        r.balance === balance &&
        r.description === description
      );

      if (isDuplicate) continue;

      bankRecords.push({
        date: formattedDate,
        description: description,
        amount: amount,
        balance: balance
      });

      if (i === 1) {
        localStorage.setItem("latestBankBalance", balance);
      }

      added++;
    }

    localStorage.setItem("bankRecords", JSON.stringify(bankRecords));

    alert(added + "件取り込みました");

    updateBankDisplay();
    drawBankBalanceChart();
  };

  reader.readAsText(file, "Shift_JIS");
}

function changeCategory(index, newCategory) {
  records[index].category = newCategory;
  localStorage.setItem("records", JSON.stringify(records));
  updateDisplay();
}

function toggleForm() {
  const form = document.getElementById("recordForm");

  if (form.style.display === "none") {
    form.style.display = "block";
  } else {
    form.style.display = "none";
  }
}


</script>
</div>
</body>
</html>
