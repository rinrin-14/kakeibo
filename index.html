<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>支出メモ</title>
</head>
<body>

<h2>支出記録</h2>

<button onclick="prevMonth()">＜</button>
<span id="monthLabel"></span>
<button onclick="nextMonth()">＞</button>


日付: <input type="date" id="date"><br><br>
金額: <input type="number" id="amount"><br><br>

支払い方法:
<select id="account">
  <option value="自分カード">自分カード</option>
  <option value="家族カード">家族カード</option>
  <option value="現金">現金</option>
</select>
<br><br>

店名: <input type="text" id="shop"><br><br>

カテゴリ:
<select id="category">
  <option value="食費">食費</option>
  <option value="外食">外食</option>
  <option value="日用品">日用品</option>
  <option value="交通">交通</option>
  <option value="趣味">趣味</option>
  <option value="その他">その他</option>
</select>
<br><br>

メモ: <input type="text" id="memo"><br><br>

<button onclick="addRecord()">追加</button>

<h3>CSV取り込み（三井住友）</h3>
<input type="file" id="csvFile" accept=".csv">
<button onclick="importCSV()">取り込み</button>

<h3>記録一覧</h3>
<ul id="list"></ul>

<h3>今月合計</h3>
自分カード: <span id="myCardTotal">0</span>円<br>
家族カード: <span id="familyCardTotal">0</span>円<br>
現金: <span id="cashTotal">0</span>円

<script>

// =======================
// 初期データ読み込み
// =======================
let records = JSON.parse(localStorage.getItem("records")) || [];

// 表示中の年月
let displayDate = new Date();

// =======================
// ページ読み込み時
// =======================
window.onload = function () {
  updateDisplay();
};

// =======================
// 月表示更新
// =======================
function updateDisplay() {
  const displayMonth = displayDate.getMonth() + 1;
  const displayYear = displayDate.getFullYear();

  // 年月ラベル
  document.getElementById("monthLabel").textContent =
    displayYear + "年" + displayMonth + "月";

  const list = document.getElementById("list");
  list.innerHTML = "";

  let myCard = 0;
  let familyCard = 0;
  let cash = 0;

  records.forEach((r, index) => {
    const recordDate = new Date(r.date);
    const recordMonth = recordDate.getMonth() + 1;
    const recordYear = recordDate.getFullYear();

    // 表示月だけ
    if (recordMonth === displayMonth && recordYear === displayYear) {
      const li = document.createElement("li");

      li.innerHTML = `
  	${r.date} ${r.account} 【${r.category || "その他"}】
  	${r.shop} ${r.amount}円 ${r.memo}
  	<button onclick="deleteRecord(${index})">削除</button>
	`;
      list.appendChild(li);

      // 合計
      if (r.account === "自分カード") myCard += r.amount;
      if (r.account === "家族カード") familyCard += r.amount;
      if (r.account === "現金") cash += r.amount;
    }
  });

  if (list.innerHTML === "") {
    list.innerHTML = "<li>この月の記録はありません</li>";
  }

  document.getElementById("myCardTotal").textContent = myCard;
  document.getElementById("familyCardTotal").textContent = familyCard;
  document.getElementById("cashTotal").textContent = cash;
}


function addRecord() {
  const date = document.getElementById("date").value;
  const amount = Number(document.getElementById("amount").value);
  const account = document.getElementById("account").value;
  const shop = document.getElementById("shop").value;
  const category = document.getElementById("category").value;
  const memo = document.getElementById("memo").value;

  if (!date || !amount) {
    alert("日付と金額は必須です");
    return;
  }

  records.push({
    date: date,
    amount: amount,
    account: account,
    shop: shop,
    category: category,
    memo: memo
  });

  localStorage.setItem("records", JSON.stringify(records));
  updateDisplay();

  // 入力リセット
  document.getElementById("amount").value = "";
  document.getElementById("shop").value = "";
  document.getElementById("memo").value = "";
}

// =======================
// 月切替
// =======================
function prevMonth() {
  displayDate.setMonth(displayDate.getMonth() - 1);
  updateDisplay();
}

function nextMonth() {
  displayDate.setMonth(displayDate.getMonth() + 1);
  updateDisplay();
}

// =======================
// 削除
// =======================
function deleteRecord(index) {
  records.splice(index, 1);
  localStorage.setItem("records", JSON.stringify(records));
  updateDisplay();
}

// =======================
// CSV取り込み（重複防止付き）
// =======================
function importCSV() {
  const fileInput = document.getElementById("csvFile");
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function (e) {
    const text = e.target.result;
    const lines = text.split("\n");

    // 1行目でカード判定
    const header = lines[0];
    let accountType = "自分カード";

    if (header.includes("Ｏｌｉｖｅ")) {
      accountType = "自分カード";
    }
    if (header.includes("ゴールドＶＩＳＡ")) {
      accountType = "家族カード";
    }

    let addedCount = 0;

    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;

      const cols = line.split(",");

      const date = cols[0];
      const shop = cols[1];
      const amount = Number(cols[2]);

      if (!date || !amount) continue;

      const formattedDate = date.replace(/\//g, "-");

      // 重複チェック
      const isDuplicate = records.some(r =>
        r.date === formattedDate &&
        r.amount === amount &&
        r.shop === shop &&
        r.account === accountType
      );

      if (!isDuplicate) {
        records.push({
          date: formattedDate,
          amount: amount,
          account: accountType,
          shop: shop,
          category: "その他"
          memo: "CSV"
        });
        addedCount++;
      }
    }

    localStorage.setItem("records", JSON.stringify(records));
    updateDisplay();

    alert(addedCount + "件取り込みました");
  };

  reader.readAsText(file, "Shift_JIS");
}


</script>
</body>
</html>
